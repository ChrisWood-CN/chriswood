{"title":"istio配置","uid":"708f551e23a08f2050cf93b09b6e8664","slug":"kubernetes/istio配置","date":"2023-06-20T05:40:32.000Z","updated":"2023-07-03T14:14:19.359Z","comments":true,"path":"api/articles/kubernetes/istio配置.json","keywords":"chriswood blogs sharing","cover":null,"content":"<h2 id=\"Gateway\"><a href=\"#Gateway\" class=\"headerlink\" title=\"Gateway\"></a>Gateway</h2><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><a href=\"https://istio.io/latest/zh/docs/reference/config/networking/gateway/\">https://istio.io/latest/zh/docs/reference/config/networking/gateway/</a></p></blockquote>\n<p>网关描述了在网格边缘运行的负载均衡器，接收传入或传出的 HTTP&#x2F;TCP 连接.该规范描述了一组应该公开的端口、<br>要使用的协议类型、负载均衡器的 SNI 配置等.用户需要确保允许流向这些端口的外部流量进入网格，一般是使用<br>type为LoadBalancer的service.定义好了网关后,然后将 VirtualService 绑定到网关以控制到达特定主机<br>或网关端口的流量的转发.</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: Gateway\nmetadata:\n  name: my-gateway\n  namespace: some-config-namespace\nspec:\n  selector:\n    app: my-gateway-controller\n  servers:  #Server describes the properties of the proxy on a given load balancer port.\n  - port: # Port describes the properties of a specific port of a service.\n      number: 80  #暴露端口 80(http)\n      name: http\n      protocol: HTTP # 端口协议  HTTP|HTTPS|GRPC|HTTP2|MONGO|TCP|TLS\n    hosts:\n    - uk.bookinfo.com   \n    - eu.bookinfo.com\n    tls: # 服务器tls设置\n      httpsRedirect: true # sends 301 redirect for http requests\n  - port:\n      number: 443 #暴露端口 80(https)\n      name: https-443\n      protocol: HTTPS\n    hosts:\n    - uk.bookinfo.com\n    - eu.bookinfo.com\n    tls:\n      mode: SIMPLE # enables HTTPS on this port\n      serverCertificate: &#x2F;etc&#x2F;certs&#x2F;servercert.pem\n      privateKey: &#x2F;etc&#x2F;certs&#x2F;privatekey.pem\n  - port:\n      number: 9443  #暴露端口 9443(https)\n      name: https-9443\n      protocol: HTTPS\n    hosts:\n    - &quot;bookinfo-namespace&#x2F;*.bookinfo.com&quot;\n    tls:\n      mode: SIMPLE # enables HTTPS on this port\n      credentialName: bookinfo-secret # fetches certs from Kubernetes secret\n  - port:\n      number: 9080  #暴露端口 9080(http)\n      name: http-wildcard\n      protocol: HTTP\n    hosts:\n    - &quot;*&quot;\n  - port:\n      number: 2379 #暴露端口 2379 (TCP)\n      name: mongo\n      protocol: MONGO\n    hosts:\n    - &quot;*&quot;</code></pre>\n\n<h2 id=\"DestinationRule\"><a href=\"#DestinationRule\" class=\"headerlink\" title=\"DestinationRule\"></a>DestinationRule</h2><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><a href=\"https://istio.io/latest/zh/docs/reference/config/networking/destination-rule/\">https://istio.io/latest/zh/docs/reference/config/networking/destination-rule/</a></p></blockquote>\n<p>DestinationRule定义了在路由发生后应用于用于服务的流量的策略.这些规则指定负载平衡的配置、sidecar的连接<br>池大小以及异常值检测设置，以检测和从负载平衡池中驱逐不健康的主机</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: DestinationRule\nmetadata:\n  name: bookinfo-ratings\nspec:\n  host: ratings.prod.svc.cluster.local\n  trafficPolicy:\n    loadBalancer:\n      simple: LEAST_REQUEST</code></pre>\n<p>DestinationRule也可以针对特定工作负载进行定制</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: DestinationRule\nmetadata:\n  name: configure-client-mtls-dr-with-workloadselector\nspec:\n  host: example.com \n  workloadSelector:  #针对特定工作负载\n    matchLabels:  #标签搜索的范围仅限于资源所在的配置命名空间\n      app: ratings\n  trafficPolicy:  # 流量策略\n    loadBalancer:\n      simple: ROUND_ROBIN\n    portLevelSettings:\n    - port:\n        number: 31443\n      tls:\n        credentialName: client-credential\n        mode: MUTUAL\n  subset: #服务端点的子集。子集可用于 A&#x2F;B 测试或路由到特定版本的服务等场景\n    - name: testversion\n    labels:  #标签对服务注册表中服务的端点应用过滤器\n      version: v3\n    trafficPolicy:  #子集级别覆盖服务级别定义的流量策略\n      loadBalancer:\n        simple: LEAST_CONN</code></pre>\n<p>TrafficPolicy</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">trafficPolicy:  # 流量策略\n  loadBalancer:  #负载均衡器算法\n    simple: ROUND_ROBIN #UNSPECIFIED|RANDOM|PASSTHROUGH|ROUND_ROBIN|LEAST_REQUEST|LEAST_CONN\n  connectionPool: #上下游连接设置\n    tcp: #tcp设置\n      maxConnections: 100\n      connectTimeout: 30ms\n      tcpKeepalive:\n        time: 7200s\n        interval: 75s\n    http: #http设置\n      http2MaxRequests: 1000\n      maxRequestsPerConnection: 10\n  outlierDetection: #异常检测 驱逐不健康的主机策略\n    consecutive5xxErrors: 7\n    interval: 5m\n    baseEjectionTime: 15m\n  portLevelSettings: #特定于各个端口的流量策略，端口级别设置将覆盖目标级别设置，当被端口级设置覆盖时，在目标级指定的流量设置将不会被继承\n    - port:\n        number: 31443\n      tls:\n        credentialName: client-credential\n        mode: MUTUAL</code></pre>\n\n\n<h2 id=\"VirtualService\"><a href=\"#VirtualService\" class=\"headerlink\" title=\"VirtualService\"></a>VirtualService</h2><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><a href=\"https://istio.io/latest/zh/docs/reference/config/networking/virtual-service/\">https://istio.io/latest/zh/docs/reference/config/networking/virtual-service/</a></p></blockquote>\n<p>影响流量路由的配置,VirtualService定义了一组流量路由规则以在寻址主机时应用,每个路由规则都定义了特定<br>协议流量的匹配标准.如果流量匹配，则将其发送到注册表中定义的指定目标服务（或其子集&#x2F;版本）</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews-route\nspec:\n  hosts:\n  - reviews.prod.svc.cluster.local #对应DestinationRule reviews-destination&gt;host\n  http:\n  - name: &quot;reviews-v2-routes&quot;\n    match:\n  - headers:\n        end-user:\n          exact: jason\n      uri:\n        prefix: &quot;&#x2F;wpcatalog&quot;\n      ignoreUriCase: true\n    - uri:\n        prefix: &quot;&#x2F;consumercatalog&quot;\n    rewrite:\n      uri: &quot;&#x2F;newcatalog&quot;\n    route:\n    - destination:\n        host: reviews.prod.svc.cluster.local #对应DestinationRule reviews-destination&gt;host\n        subset: v2 # 对应subsets&gt;v2\n  - name: &quot;reviews-v1-route&quot;\n    route:\n    - destination:\n        host: reviews.prod.svc.cluster.local #对应DestinationRule reviews-destination&gt;host\n        subset: v1 # 对应subsets&gt;v1\n</code></pre>\n<p>路由目的地的子集&#x2F;版本通过对命名服务子集的引用来标识，该子集必须在相应的DestinationRule中声明</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: DestinationRule\nmetadata:\n  name: reviews-destination\nspec:\n  host: reviews.prod.svc.cluster.local #host\n  subsets:\n  - name: v1 #subsets&gt;v1\n    labels:\n      version: v1\n  - name: v2 #subsets&gt;v2\n    labels:\n      version: v2</code></pre>\n","feature":true,"text":"Gateway https://istio.io/latest/zh/docs/reference/config/networking/gateway/ 网关描述了在网格边缘运行的负载均衡器，接收传入或传出的 HTTP&#x2F;TCP 连接.该规范描述了一组应该公开的端口、要使...","link":"","photos":[],"count_time":{"symbolsCount":"4.9k","symbolsTime":"4 mins."},"categories":[{"name":"kubenetes","slug":"kubenetes","count":1,"path":"api/categories/kubenetes.json"}],"tags":[{"name":"kubernetes","slug":"kubernetes","count":7,"path":"api/tags/kubernetes.json"},{"name":"istio","slug":"istio","count":2,"path":"api/tags/istio.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Gateway\"><span class=\"toc-text\">Gateway</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#DestinationRule\"><span class=\"toc-text\">DestinationRule</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#VirtualService\"><span class=\"toc-text\">VirtualService</span></a></li></ol>","author":{"name":"ChrisWood","slug":"blog-author","avatar":"https://chriswood-blog.oss-cn-shanghai.aliyuncs.com/me/avatar.png","link":"/","description":"Think like an artist, code like an artisan.","socials":{"github":"https://github.com/chriswoodcn","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"md数学公式编辑","uid":"ea39305e79caf19d55943f507e070012","slug":"tools/md数学公式编辑","date":"2023-06-21T06:41:12.000Z","updated":"2023-07-03T14:14:19.367Z","comments":true,"path":"api/articles/tools/md数学公式编辑.json","keywords":"chriswood blogs sharing","cover":null,"text":"公式插入行内公式 $ 数学公式 $ 块级公式 $$ 数学公式 $$ 书写函数1.三角函数 名称 书写 Markdown 角 $\\angle$ $\\angle $ 30度角 $30^\\circ$ $30^\\circ$ 90度角 $\\bot$ $\\bot$ 正弦 $\\sin$ $\\s...","link":"","photos":[],"count_time":{"symbolsCount":"3.5k","symbolsTime":"3 mins."},"categories":[{"name":"markdown","slug":"markdown","count":1,"path":"api/categories/markdown.json"}],"tags":[{"name":"markdown","slug":"markdown","count":1,"path":"api/tags/markdown.json"}],"author":{"name":"ChrisWood","slug":"blog-author","avatar":"https://chriswood-blog.oss-cn-shanghai.aliyuncs.com/me/avatar.png","link":"/","description":"Think like an artist, code like an artisan.","socials":{"github":"https://github.com/chriswoodcn","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"crontab命令","uid":"7e88b6e7d56f70f641065fe39e058881","slug":"linux/crontab命令","date":"2023-06-20T01:58:10.000Z","updated":"2023-07-03T14:14:19.359Z","comments":true,"path":"api/articles/linux/crontab命令.json","keywords":"chriswood blogs sharing","cover":null,"text":"简介crontab命令常见于Unix和类Unix的操作系统之中，用于设置周期性被执行的指令。该命令从标准输入设备读取指令，并将其存放于“crontab”文件中（是“cron table”的简写） 使用检查crontab服务crontab -l #显示‘no crontab for...","link":"","photos":[],"count_time":{"symbolsCount":"3.3k","symbolsTime":"3 mins."},"categories":[{"name":"Linux","slug":"Linux","count":2,"path":"api/categories/Linux.json"}],"tags":[{"name":"Linux","slug":"Linux","count":2,"path":"api/tags/Linux.json"},{"name":"crontab","slug":"crontab","count":1,"path":"api/tags/crontab.json"}],"author":{"name":"ChrisWood","slug":"blog-author","avatar":"https://chriswood-blog.oss-cn-shanghai.aliyuncs.com/me/avatar.png","link":"/","description":"Think like an artist, code like an artisan.","socials":{"github":"https://github.com/chriswoodcn","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}