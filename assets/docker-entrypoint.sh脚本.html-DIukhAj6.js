import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,o as l,b as i,a as s}from"./app-D5FmEbjh.js";const t={},h=i(`<h1 id="docker-entrypoint-sh-脚本说明" tabindex="-1"><a class="header-anchor" href="#docker-entrypoint-sh-脚本说明"><span>docker-entrypoint.sh 脚本说明</span></a></h1><h2 id="出处" tabindex="-1"><a class="header-anchor" href="#出处"><span>出处</span></a></h2><p>很多著名库的 Dockerfile 文件中，通常都是 ENTRYPOINT 字段是这样：</p><div class="language-dockerfile line-numbers-mode" data-highlighter="shiki" data-ext="dockerfile" data-title="dockerfile" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#61AFEF;">ENTRYPOINT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;docker-entrypoint.sh&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="用处" tabindex="-1"><a class="header-anchor" href="#用处"><span>用处</span></a></h2><p>我们参考分析下 MySQL 的 Dockerfile 文件，来认识下 docker-entrypoint.sh 的用处</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">set</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -eo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pipefail</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">shopt</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nullglob</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># if command starts with an option, prepend mysqld</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">\${1</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">1}</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;-&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">	set</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mysqld</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># skip setup if they want an option that stops mysqld</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">wantHelp</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> arg; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	case</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$arg</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#E06C75;">		-</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;?&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#E06C75;">--help</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#E06C75;">--print-defaults</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#E06C75;">-V</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#E06C75;">--version</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">			wantHelp</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">			break</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">			;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	esac</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">done</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># usage: file_env VAR [DEFAULT]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">#    ie: file_env &#39;XYZ_DB_PASSWORD&#39; &#39;example&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># (will allow for &quot;$XYZ_DB_PASSWORD_FILE&quot; to fill in the value of</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">#  &quot;$XYZ_DB_PASSWORD&quot; from a file, especially for Docker&#39;s secrets feature)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">file_env</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> var</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> fileVar</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">var</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}_FILE&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> def</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">\${2</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:-</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">var</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:-</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ] &amp;&amp; [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">fileVar</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:-</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		echo</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;&amp;2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;error: both </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$var</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> and </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$fileVar</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are set (but are exclusive)&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> val</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$def</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">var</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:-</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">		val</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">var</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	elif</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">fileVar</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:-</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">		val</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;$(</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">fileVar</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;)&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	export</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$var</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$val</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">	unset</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$fileVar</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># usage: process_init_file FILENAME MYSQLCOMMAND...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">#    ie: process_init_file foo.sh mysql -uroot</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># (process a single initializer file, based on its extension. we define this</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># function here, so that initializer scripts (*.sh) can use the same logic,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># potentially recursively, or override the logic used in subsequent calls)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">process_init_file</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> f</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">shift</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">( </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	case</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">		*</span><span style="--shiki-light:#032F62;--shiki-dark:#E06C75;">.sh</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">     echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: running </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">		*</span><span style="--shiki-light:#032F62;--shiki-dark:#E06C75;">.sql</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: running </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">		*</span><span style="--shiki-light:#032F62;--shiki-dark:#E06C75;">.sql.gz</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: running </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">gunzip</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">		*)</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: ignoring </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	esac</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">	echo</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">_check_config</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">	toRun</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">( </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> --verbose</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> --help</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> errors</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">toRun</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> 2&gt;&amp;1</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/dev/null)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;&amp;2</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;&lt;-</span><span style="--shiki-light:#032F62;--shiki-dark:#ABB2BF;">EOM</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			ERROR: mysqld failed while attempting to check config</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			command was: &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">toRun</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">			$errors</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ABB2BF;">		EOM</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	fi</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># Fetch value from server config</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># We use mysqld --verbose --help instead of my_print_defaults because the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># latter only show values present in config files, and not server defaults</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">_get_config</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> conf</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">shift</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">	&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --verbose</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --help</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --log-bin-index=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mktemp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">)&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> 2&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/dev/null</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">		|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;$1 == &quot;&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$conf</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;&#39;&quot; &amp;&amp; /^[^ \\t]/ { sub(/^[^ \\t]+[ \\t]+/, &quot;&quot;); print; exit }&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">	# match &quot;datadir      /some/path with/spaces in/it here&quot; but not &quot;--xyz=abc\\n     datadir (xyz)&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># allow the container to be started with \`--user\`</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;mysqld&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -a</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$wantHelp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">id</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">)&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">	_check_config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">	DATADIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">_get_config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;datadir&#39; &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;)&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">	mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$DATADIR</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">	chown</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -R</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mysql:mysql</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$DATADIR</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">	exec</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> gosu</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mysql</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$BASH_SOURCE</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;mysqld&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -a</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$wantHelp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">	# still need to check config, container may have started with --user</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">	_check_config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">	# Get config</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">	DATADIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">_get_config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;datadir&#39; &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$DATADIR</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/mysql&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		file_env</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MYSQL_ROOT_PASSWORD&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -a</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_ALLOW_EMPTY_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -a</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_RANDOM_ROOT_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;&amp;2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;error: database is uninitialized and password option is not specified &#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;&amp;2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;  You need to specify one of MYSQL_ROOT_PASSWORD, MYSQL_ALLOW_EMPTY_PASSWORD and MYSQL_RANDOM_ROOT_PASSWORD&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$DATADIR</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;Initializing database&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --initialize-insecure</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;Database initialized&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> command</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -v</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mysql_ssl_rsa_setup</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /dev/null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &amp;&amp; [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$DATADIR</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/server-key.pem&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">			# https://github.com/mysql/mysql-server/blob/23032807537d8dd8ee4ec1c4d40f0633cd4e12f9/packaging/deb-in/extra/mysql-systemd-start#L81-L84</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;Initializing certificates&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">			mysql_ssl_rsa_setup</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --datadir=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$DATADIR</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;Certificates initialized&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">		SOCKET</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">_get_config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;socket&#39; &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;)&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --skip-networking</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --socket=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">SOCKET</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &amp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">		pid</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">$!</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">		mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">( </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D19A66;"> --protocol</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">socket</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -uroot</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -hlocalhost</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D19A66;"> --socket</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">SOCKET</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		for</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">30..0}</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;SELECT 1&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> /dev/null; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">				break</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">			fi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MySQL init process in progress...&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">			sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		done</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$i</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;&amp;2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MySQL init process failed.&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">-z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_INITDB_SKIP_TZINFO</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">			# sed is for https://bugs.mysql.com/bug.php?id=20545</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">			mysql_tzinfo_to_sql</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/share/zoneinfo</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> sed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;s/Local time zone must be set--see zic manual page/FCTY/&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mysql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_RANDOM_ROOT_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">			export</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pwgen</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 32</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">)&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;GENERATED ROOT PASSWORD: </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">		rootCreate</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">		# default root to listen for connections from anywhere</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		file_env</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MYSQL_ROOT_HOST&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;%&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_ROOT_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_ROOT_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;localhost&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">			# no, we don&#39;t care if read finds a terminating character in this heredoc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">			# https://unix.stackexchange.com/questions/265149/why-is-set-o-errexit-breaking-this-read-heredoc-expression/265151#265151</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			read</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -r</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rootCreate</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;&lt;-</span><span style="--shiki-light:#032F62;--shiki-dark:#ABB2BF;">EOSQL</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">				CREATE USER &#39;root&#39;@&#39;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MYSQL_ROOT_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&#39; IDENTIFIED BY &#39;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&#39; ;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">				GRANT ALL ON *.* TO &#39;root&#39;@&#39;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MYSQL_ROOT_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&#39; WITH GRANT OPTION ;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ABB2BF;">			EOSQL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;&lt;-</span><span style="--shiki-light:#032F62;--shiki-dark:#ABB2BF;">EOSQL</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			-- What&#39;s done in this file shouldn&#39;t be replicated</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			--  or products like mysql-fabric won&#39;t work</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			SET @@SESSION.SQL_LOG_BIN=0;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&#39; ;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			GRANT ALL ON *.* TO &#39;root&#39;@&#39;localhost&#39; WITH GRANT OPTION ;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">rootCreate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			DROP DATABASE IF EXISTS test ;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">			FLUSH PRIVILEGES ;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ABB2BF;">		EOSQL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">			mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">( </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">-p&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		file_env</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MYSQL_DATABASE&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_DATABASE</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;CREATE DATABASE IF NOT EXISTS </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_DATABASE</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\\`</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ;&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">			mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">( </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_DATABASE</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		file_env</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MYSQL_USER&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		file_env</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MYSQL_PASSWORD&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;CREATE USER &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;@&#39;%&#39; IDENTIFIED BY &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39; ;&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_DATABASE</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">				echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;GRANT ALL ON </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_DATABASE</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\\`</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.* TO &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;@&#39;%&#39; ;&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">			fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;FLUSH PRIVILEGES ;&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		echo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		ls</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /docker-entrypoint-initdb.d/</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /dev/null</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		for</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> f</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /docker-entrypoint-initdb.d/*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">			process_init_file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]}&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		done</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> -z</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$MYSQL_ONETIME_PASSWORD</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">			&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">]}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;&lt;-</span><span style="--shiki-light:#032F62;--shiki-dark:#ABB2BF;">EOSQL</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">				ALTER USER &#39;root&#39;@&#39;%&#39; PASSWORD EXPIRE;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ABB2BF;">			EOSQL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> TERM</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$pid</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> ||</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> wait</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$pid</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			echo</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;&amp;2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MySQL init process failed.&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">			exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">		fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		echo</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;MySQL init process done. Ready for start up.&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">		echo</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">exec</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在启动容器时，可以通过 shell 脚本执行些预处理逻辑，然后通过 exec &quot;$@&quot;，把启动容器入口正式交给使用者</p><h2 id="文件编辑" tabindex="-1"><a class="header-anchor" href="#文件编辑"><span>文件编辑</span></a></h2><h4 id="set-e" tabindex="-1"><a class="header-anchor" href="#set-e"><span>set -e</span></a></h4><p>你写的每个脚本都应该在文件开头加上 set -e, 这句语句告诉 bash 如果任何语句的执行结果不是 true 则应该退出. 这样的好处是防止错误像滚雪球般变大导致一个致命的错误, 而这些错误本应该在之前就被处理掉. 如果要增加可 读性, 可以使用 set -o errexit, 它的作用与 set -e 相同</p><h4 id="set-o-pipefail" tabindex="-1"><a class="header-anchor" href="#set-o-pipefail"><span>set -o pipefail</span></a></h4><p>设计用途同上, 就是希望在执行错误之后立即退出, 不要再向下执行了. 而 -o pipefail 的作用域是管道, 也 就是说在 Linux 脚本中的管道, 如果前面的命令执行出了问题, 应该立即退出</p><h4 id="shopt-s-nullglob" tabindex="-1"><a class="header-anchor" href="#shopt-s-nullglob"><span>shopt -s nullglob</span></a></h4><p>在使用 Linux 中的通配符时 * ?等如果没有匹配到任何文件, 不会报 No such file or directory 而是将命 令后面的参数去掉执行</p><h4 id="if-1-0-1-then" tabindex="-1"><a class="header-anchor" href="#if-1-0-1-then"><span>if [ “\${1:0:1}” = ‘-‘ ]; then…</span></a></h4><p>这是一个判断语句, 在官方文件中, 上一行已经给出了注释: if command starts with an option, prepend mysqld 这个判断语句是 \${1:0:1} 意思是判断 $1(调用该脚本的第一个参数), 偏移量 0(不偏移), 取一个字符 (取字符串的长度)如果判断出来调用这个脚本后面所跟的参数第一个字符是-中横线的话, 就认为后面的所有字符串都 是 mysqld 的启动参数 上面的这个操作类似于 Python 的字符串切片</p><h4 id="set-–-mysqld" tabindex="-1"><a class="header-anchor" href="#set-–-mysqld"><span>set – mysqld “$@”</span></a></h4><p>在上面判断完第一个参数是-开头之后, 紧接着就执行了 set -- mysqld &quot;$@&quot; 这个命令. 使用了 set -- 的用 法. set —会将他后面所有以空格区分的字符串, 按顺序分别存储到$1, $2, $3 变量中, 其中新的$@ 为 set — 后面的全部内容 举例来说: bash docker-entrypoint.sh -f xxx.conf 在这种情况下, set -- mysqld &quot;$@&quot; 中的 $@ 的值为 -f xxx.conf 当执行完 set -- mysqld &quot;$@&quot; 这条命令后: $1=mysqld $2=-f $3=xxx.conf $@=mysqld -f xxx.conf 可以看到, 当执行 docker-entrypoint.sh 脚本的时候后面加了 -x 形式的参数之后, $@的值发生的改变, 在原有 $@值的基础之上, 在前面又预添加了 mysqld 命令</p><h4 id="exec" tabindex="-1"><a class="header-anchor" href="#exec"><span>exec “$@”</span></a></h4><p>几乎在每个 docker-entrypoint.sh 脚本的最后一行, 执行的都是 exec &quot;$@&quot;命令 这个命令的意义在于你已经为你的镜像预想到了应该有的调用情况, 当实际使用镜像的人执行了你没有预料到的可执行 命令时, 将会走到脚本的这最后一行, 去执行用户新的可执行命令</p><h4 id="情况判断" tabindex="-1"><a class="header-anchor" href="#情况判断"><span>情况判断</span></a></h4><p>上面直接说了脚本的最后一行, 在之前的脚本中, 需要充分的去考虑你自己的脚本可能会被调用的情况. 还是拿 MySQL 官方的 dockerfile 来说, 他判断以下情况: 开头是 - , 认为是参数的情况 开头是 mysqld, 且用户 id 为 0 (root 用户) 的情况 开头是 mysqld 的情况 判断完自己应用的所有调用形态之后, 最后应该加上 exec &quot;$@&quot; 命令兜底</p>`,23),k=s("h4",{"mysql[@]":"",id:"",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#"},[s("span",null,"$")])],-1),e=i(`<p>Shell 中的数组, 直接执行 \${mysql[@]} 会把这个数组当做可执行程序来执行</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">( </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">mysql</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D19A66;"> --protocol</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">socket</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -uroot</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -hlocalhost</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D19A66;"> --socket</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">SOCKET</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> )</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[1]}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">#mysql</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[2]}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">#--protocol=socket</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[3]}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">#-uroot</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[4]}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">#-hlocalhost</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mysql</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">]}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mysql</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --protocol=socket</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -uroot</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -hlocalhost</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --socket=</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="exec-gosu-mysql-bash-source" tabindex="-1"><a class="header-anchor" href="#exec-gosu-mysql-bash-source"><span>exec gosu mysql “$BASH_SOURCE” “$@”</span></a></h4><p>这里的 gosu 命令, 是 Linux 中 sudo 命令的轻量级”替代品” gosu 是一个 golang 语言开发的工具, 用来取代 shell 中的 sudo 命令. su 和 sudo 命令有一些缺陷, 主要 是会引起不确定的 TTY, 对信号量的转发也存在问题. 如果仅仅为了使用特定的用户运行程序, 使用 su 或 sudo 显 得太重了, 为此 gosu 应运而生. gosu 直接借用了 libcontainer 在容器中启动应用程序的原理, 使用 /etc/passwd 处理应用程序. gosu 首先 找出指定的用户或用户组, 然后切换到该用户或用户组. 接下来, 使用 exec 启动应用程序. 到此为止, gosu 完成 了它的工作, 不会参与到应用程序后面的声明周期中. 使用这种方式避免了 gosu 处理 TTY 和转发信号量的问题, 把 这两个工作直接交给了应用程序去完成</p>`,4),p=[h,k,e];function d(r,y){return l(),n("div",null,p)}const c=a(t,[["render",d],["__file","docker-entrypoint.sh脚本.html.vue"]]),o=JSON.parse('{"path":"/zh/posts/docker/docker-entrypoint.sh%E8%84%9A%E6%9C%AC.html","title":"docker-entrypoint.sh脚本","lang":"zh-CN","frontmatter":{"title":"docker-entrypoint.sh脚本","date":"2023-06-09T14:13:44.000Z","categories":"docker","tags":["docker","docker-entrypoint"],"description":"docker-entrypoint.sh 脚本说明 出处 很多著名库的 Dockerfile 文件中，通常都是 ENTRYPOINT 字段是这样： 用处 我们参考分析下 MySQL 的 Dockerfile 文件，来认识下 docker-entrypoint.sh 的用处 在启动容器时，可以通过 shell 脚本执行些预处理逻辑，然后通过 exec \\"...","head":[["meta",{"property":"og:url","content":"https://mister-hope.github.io/zh/posts/docker/docker-entrypoint.sh%E8%84%9A%E6%9C%AC.html"}],["meta",{"property":"og:site_name","content":"博客"}],["meta",{"property":"og:title","content":"docker-entrypoint.sh脚本"}],["meta",{"property":"og:description","content":"docker-entrypoint.sh 脚本说明 出处 很多著名库的 Dockerfile 文件中，通常都是 ENTRYPOINT 字段是这样： 用处 我们参考分析下 MySQL 的 Dockerfile 文件，来认识下 docker-entrypoint.sh 的用处 在启动容器时，可以通过 shell 脚本执行些预处理逻辑，然后通过 exec \\"..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-06-19T08:58:34.000Z"}],["meta",{"property":"article:author","content":"chriswoodcn"}],["meta",{"property":"article:tag","content":"docker"}],["meta",{"property":"article:tag","content":"docker-entrypoint"}],["meta",{"property":"article:published_time","content":"2023-06-09T14:13:44.000Z"}],["meta",{"property":"article:modified_time","content":"2024-06-19T08:58:34.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"docker-entrypoint.sh脚本\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-06-09T14:13:44.000Z\\",\\"dateModified\\":\\"2024-06-19T08:58:34.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"chriswoodcn\\"}]}"]]},"headers":[{"level":2,"title":"出处","slug":"出处","link":"#出处","children":[]},{"level":2,"title":"用处","slug":"用处","link":"#用处","children":[]},{"level":2,"title":"文件编辑","slug":"文件编辑","link":"#文件编辑","children":[]}],"git":{"createdTime":1718787514000,"updatedTime":1718787514000,"contributors":[{"name":"chriswoodcn","email":"chriswoodcn@aliyun.com","commits":1}]},"readingTime":{"minutes":6.86,"words":2057},"filePathRelative":"zh/posts/docker/docker-entrypoint.sh脚本.md","localizedDate":"2023年6月9日","excerpt":"\\n<h2>出处</h2>\\n<p>很多著名库的 Dockerfile 文件中，通常都是 ENTRYPOINT 字段是这样：</p>\\n<div class=\\"language-dockerfile line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"dockerfile\\" data-title=\\"dockerfile\\" style=\\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes github-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#61AFEF\\">ENTRYPOINT</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\"> [</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#98C379\\">\\"docker-entrypoint.sh\\"</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">]</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{c as comp,o as data};
